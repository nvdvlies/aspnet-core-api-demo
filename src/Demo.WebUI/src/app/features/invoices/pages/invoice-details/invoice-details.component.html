{{ initFromRoute$ | async }}

<ng-container *ngIf="vm$ | async as vm; else loading">
  <ng-container *ngIf="!vm.isLoading; else loading">
    <ng-container *ngIf="vm.loadingEntityFailed && vm.problemDetails">
      <div class="page-load-error-container">
        <app-problem-details [problemDetails]="vm.problemDetails"></app-problem-details>
      </div>
    </ng-container>
    <ng-container *ngIf="!vm.loadingEntityFailed">
      <form [formGroup]="form" novalidate (ngSubmit)="save()">
        <app-page-header
          title="{{ vm.id != null ? 'Invoice: ' + vm.pristine?.invoiceNumber : 'New invoice' }}"
        >
          <button
            mat-icon-button
            type="button"
            *ngIf="vm.id != null"
            routerLink="auditlog"
            matTooltip="Audit log"
          >
            <mat-icon>history</mat-icon>
          </button>
          <button
            mat-raised-button
            color="primary"
            type="submit"
            [disabled]="vm.isSaving"
            [class.button-spinner]="vm.isSaving"
          >
            Save
          </button>
          <button
            mat-raised-button
            (click)="delete()"
            type="button"
            *ngIf="vm.id != null && vm.entity?.status === InvoiceStatusEnum.Draft"
            [disabled]="vm.isDeleting"
            [class.button-spinner]="vm.isDeleting"
          >
            Delete
          </button>
          <button mat-raised-button routerLink="/invoices" type="button">Close</button>
          <div class="auditlog" *ngIf="vm.id != null">
            <small
              >Created by
              {{ vm.pristine?.createdBy | userIdToName | async }}
              on {{ vm.pristine?.createdOn | date: 'short' }}</small
            >
            <small
              >Last modified by
              {{ vm.pristine?.lastModifiedBy | userIdToName | async }}
              on {{ vm.pristine?.lastModifiedOn | date: 'short' }}</small
            >
          </div>
        </app-page-header>
        <div class="content-container">
          <app-problem-details [problemDetails]="vm.problemDetails"></app-problem-details>
          <app-message type="warning" *ngIf="vm.hasNewerVersionWithMergeConflict">
            This invoice has just been modified by somebody else and that modification contains
            changes which conflict with your pending changes. Please click 'Refresh' to switch to
            the persisted version of the invoice. Your pending changes will be lost.
            <div>
              <button
                mat-stroked-button
                (click)="resolveMergeConflictWithTakeTheirs()"
                type="button"
              >
                Refresh
              </button>
            </div>
          </app-message>
          <mat-card class="card shadow-md bg-white pb-1 pl-3 pr-3 pt-0 mt-1 mb-3">
            <mat-card-title class="pl-1 pt-1 text-lg">General</mat-card-title>
            <mat-card-content>
              <div class="row">
                <div class="col">
                  <mat-form-field appearance="fill" class="full-width">
                    <mat-label>Invoice date</mat-label>
                    <input
                      matInput
                      [appSetFocus]="vm.id == null"
                      formControlName="invoiceDate"
                      [matDatepicker]="picker"
                      placeholder="Invoice date"
                      type="text"
                    />
                    <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                    <mat-datepicker #picker></mat-datepicker>
                    <mat-error appDomainEntityErrorMessage></mat-error>
                  </mat-form-field>
                </div>
              </div>
              <div class="row">
                <div class="col">
                  <mat-form-field appearance="fill" class="full-width">
                    <mat-label>Customer</mat-label>
                    <button
                      type="button"
                      mat-button
                      matPrefix
                      mat-icon-button
                      (click)="customerAutocomplete.focus()"
                    >
                      <mat-icon>search</mat-icon>
                    </button>
                    <app-customer-autocomplete-form-field-control
                      #customerAutocomplete
                      matInput
                      placeholder="Customer"
                      formControlName="customerId"
                    >
                    </app-customer-autocomplete-form-field-control>
                    <button
                      *ngIf="customerAutocomplete.value != null"
                      type="button"
                      mat-button
                      mat-icon-button
                      matSuffix
                      (click)="customerAutocomplete.clearSearchField()"
                      [disabled]="customerAutocomplete.disabled"
                    >
                      <mat-icon>close</mat-icon>
                    </button>
                    <mat-error appDomainEntityErrorMessage></mat-error>
                  </mat-form-field>
                </div>
              </div>
              <div class="row">
                <div class="col">
                  <mat-form-field appearance="fill" class="full-width">
                    <mat-label>Order reference</mat-label>
                    <input
                      matInput
                      placeholder="Order reference"
                      formControlName="orderReference"
                      type="text"
                    />
                    <mat-error appDomainEntityErrorMessage></mat-error>
                  </mat-form-field>
                </div>
              </div>
            </mat-card-content>
          </mat-card>

          <mat-card class="card shadow-md bg-white pb-3 pl-3 pr-3 pt-0 pb-2 mt-1 mb-2">
            <mat-card-title class="pl-1 pt-1 text-lg">Invoice lines</mat-card-title>
            <mat-card-content>
              <ng-container formArrayName="invoiceLines">
                <table class="mat-table cdk-table">
                  <thead role="rowgroup">
                    <tr class="mat-header-row cdk-header-row">
                      <th class="mat-header-cell cdk-header-cell border-0 pl-4 text-left">
                        Quantity
                      </th>
                      <th class="mat-header-cell cdk-header-cell border-0 text-left">
                        Description
                      </th>
                      <th class="mat-header-cell cdk-header-cell border-0 text-left">
                        Selling price
                      </th>
                      <th class="mat-header-cell cdk-header-cell border-0"></th>
                    </tr>
                  </thead>
                  <tbody role="rowgroup">
                    <tr class="mat-row cdk-row" *ngFor="let _ of invoiceLines.controls; index as i">
                      <ng-container [formGroupName]="i">
                        <td class="mat-cell cdk-cell border-0 px-1 w-1/12">
                          <mat-form-field appearance="fill" class="full-width">
                            <mat-label>Quantity</mat-label>
                            <input
                              matInput
                              type="number"
                              formControlName="quantity"
                              placeholder="Quantity"
                            />
                            <mat-error appDomainEntityErrorMessage></mat-error>
                          </mat-form-field>
                        </td>
                        <td class="mat-cell cdk-cell border-0 px-1">
                          <mat-form-field appearance="fill" class="full-width">
                            <mat-label>Description</mat-label>
                            <input
                              matInput
                              formControlName="description"
                              placeholder="Description"
                              type="text"
                            />
                            <mat-error appDomainEntityErrorMessage></mat-error>
                          </mat-form-field>
                        </td>
                        <td class="mat-cell cdk-cell border-0 px-1 w-1/12">
                          <mat-form-field appearance="fill" class="full-width">
                            <mat-label>Selling price</mat-label>
                            <app-currency-form-field-control
                              matInput
                              formControlName="sellingPrice"
                              placeholder="Selling price"
                              type="text"
                            ></app-currency-form-field-control>
                            <mat-error appDomainEntityErrorMessage></mat-error>
                          </mat-form-field>
                        </td>
                        <td class="mat-cell cdk-cell w-0 border-0 pr-0 pb-4 whitespace-nowrap">
                          <button
                            mat-icon-button
                            type="button"
                            (click)="removeInvoiceLine(i)"
                            matTooltip="Remove line"
                            [disabled]="
                              !vm.canEditInvoiceContent || invoiceLines.controls.length === 1
                            "
                          >
                            <mat-icon>delete</mat-icon>
                          </button>
                        </td>
                      </ng-container>
                    </tr>
                  </tbody>
                </table>
              </ng-container>
              <button
                mat-raised-button
                type="button"
                (click)="addInvoiceLine()"
                [disabled]="!vm.canEditInvoiceContent"
              >
                <mat-icon>add</mat-icon> Add line
              </button>
            </mat-card-content>
          </mat-card>
        </div>
        <!-- <pre>{{ form.value | json }}</pre> -->
      </form>
    </ng-container>
  </ng-container>
  <!-- <pre>{{ vm | json }}</pre> -->
</ng-container>

<ng-template #loading>
  <app-spinner diameter="50"></app-spinner>
</ng-template>
