{{ initFromRoute$ | async }}

<ng-container *ngIf="vm$ | async as vm; else loading">
  <ng-container *ngIf="!vm.isLoading; else loading">
    <ng-container *ngIf="vm.loadingEntityFailed && vm.problemDetails">
      <div class="page-load-error-container">
        <app-problem-details [problemDetails]="vm.problemDetails"></app-problem-details>
      </div>
    </ng-container>
    <ng-container *ngIf="!vm.loadingEntityFailed">
      <form [formGroup]="form" novalidate (ngSubmit)="save()">
        <app-page-header
          title="{{
            vm.id != null
              ? 'Customer: ' + vm.pristine?.code + ' - ' + vm.pristine?.name
              : 'New customer'
          }}"
        >
          <button mat-icon-button type="button" *ngIf="vm.id != null" routerLink="auditlog">
            <mat-icon>history</mat-icon>
          </button>
          <button
            mat-raised-button
            color="primary"
            type="submit"
            [disabled]="vm.isSaving"
            [class.button-spinner]="vm.isSaving"
          >
            Save
          </button>
          <button
            mat-raised-button
            (click)="delete()"
            type="button"
            *ngIf="vm.id != null"
            [disabled]="vm.isDeleting"
            [class.button-spinner]="vm.isDeleting"
          >
            Delete
          </button>
          <button mat-raised-button routerLink="/customers" type="button">Close</button>
          <div class="auditlog" *ngIf="vm.id != null">
            <small
              >Created by
              <a routerLink="/users/{{ vm.pristine?.createdBy }}">{{
                vm.pristine?.createdBy | userIdToName | async
              }}</a>
              on {{ vm.pristine?.createdOn | date: 'short' }}</small
            >
            <small
              >Last modified by
              <a routerLink="/users/{{ vm.pristine?.lastModifiedBy }}">{{
                vm.pristine?.lastModifiedBy | userIdToName | async
              }}</a>
              on {{ vm.pristine?.lastModifiedOn | date: 'short' }}</small
            >
          </div>
        </app-page-header>
        <div class="content-container">
          <app-problem-details
            [problemDetails]="vm.problemDetails"
            [formGroup]="form"
          ></app-problem-details>
          <app-message type="warning" *ngIf="vm.hasNewerVersionWithMergeConflict">
            This customer has just been modified by somebody else and that modification contains
            changes which conflict with your pending changes. Please click 'Refresh' to switch to
            the persisted version of the customer. Your pending changes will be lost.
            <div>
              <button
                mat-stroked-button
                (click)="resolveMergeConflictWithTakeTheirs()"
                type="button"
              >
                Refresh
              </button>
            </div>
          </app-message>
          <mat-card class="card">
            <mat-card-header>
              <mat-card-title>General</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="row">
                <div class="col">
                  <mat-form-field class="full-width">
                    <input
                      matInput
                      [appFocus]="vm.id == null"
                      placeholder="Name"
                      formControlName="name"
                    />
                    <mat-error appDomainEntityErrorMessage></mat-error>
                  </mat-form-field>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
        {{ form.value | json }}
      </form>
    </ng-container>
  </ng-container>
  <!-- {{ vm | json }} -->
</ng-container>

<ng-template #loading>
  <div class="spinner-container">
    <mat-spinner [diameter]="50"></mat-spinner>
  </div>
</ng-template>
